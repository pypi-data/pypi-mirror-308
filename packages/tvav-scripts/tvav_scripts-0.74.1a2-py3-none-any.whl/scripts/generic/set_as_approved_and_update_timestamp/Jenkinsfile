pipeline {
  agent any
  environment {
    MONGODB__CREDS = credentials("MONGODB__CREDS")
    MONGODB__DB_NAME = credentials("MONGODB__DB_NAME")
  }

  options {
    timestamps()
    skipDefaultCheckout(true)
    buildDiscarder logRotator(
      artifactDaysToKeepStr: '',
      artifactNumToKeepStr: '',
      daysToKeepStr: '5',
      numToKeepStr: '3'
    )
  }

  parameters {
    text(
      name: 'WORK_ID_LIST',
      defaultValue: '',
      description: 'A list of work_ids to re-ingest. Please 1 work_id per line.'
    )
    string(
      name: 'WORK_ID',
      defaultValue: 'program_id',
      description: 'The work_id to be used when using the WORK_ID_LIST parameters to find AvWorks in the DB. **Use plasma_id for YLE**'
    )
  }

  stages {
    stage('Clone repository') {
      steps {
        cleanWs()
        checkout scm
      }
    }

    stage('Script') {
      steps {
        sh '''
          # we need to install the scripts package
          python3 -m venv venv
          . venv/bin/activate
          pip install poetry==1.7.1
          . venv/bin/activate
          poetry install

          # we install now the script requirements
          cd scripts/generic/set_as_approved_and_update_timestamp
          # script expects a CSV file
          echo $WORK_ID_LIST | tr " " "\n" > input.csv
          pip install -q -U -r requirements.txt

          python3 main.py
        '''
      }
    }
  }
  post {
    always {
      archiveArtifacts artifacts: 'scripts/generic/set_as_approved_and_update_timestamp/**.csv', fingerprint: true
    }
  }
}
