pipeline {
  agent any
  environment {
    MONGODB__CREDS = credentials("TVAV_CUESHEETS_MONGO_CREDS")
    MONGODB__DB_NAME = credentials("MONGODB__DB_NAME")
  }

  options {
    timestamps()
    skipDefaultCheckout(true)
    buildDiscarder logRotator(
      artifactDaysToKeepStr: '',
      artifactNumToKeepStr: '',
      daysToKeepStr: '5',
      numToKeepStr: '3'
    )
  }

  parameters {
    string(
      name: 'START_TIME_MIN',
      defaultValue: '2024-05-05',
      description: 'Minimum start_time (in UTC).'
    )
    string(
      name: 'START_TIME_MAX',
      defaultValue: '2024-05-06',
      description: 'Maximum start_time (in UTC).'
    )
  }

  stages {
    stage('Clone repository') {
      steps {
        cleanWs()
        checkout scm
      }
    }

    stage('Script') {
      steps {
        sh '''
          # we need to install the scripts package
          python3 -m venv venv
          . venv/bin/activate
          pip install poetry==1.7.1
          . venv/bin/activate
          poetry install

          # we install now the script requirements
          cd scripts/generic/jenkins_workshop
          pip install -q -U -r requirements.txt

          python3 main.py
        '''
      }
    }
  }
  post {
    always {
      archiveArtifacts artifacts: 'scripts/generic/jenkins_workshop/**.csv', fingerprint: true
    }
  }
}
