pipeline {
  agent any
  environment {
    MONGODB__CREDS = credentials("TVAV_CUESHEETS_MONGO_CREDS")
    KAFKA__SASL_PLAIN_USERNAME = credentials("KAFKA_SASL_PLAIN_USERNAME")
    KAFKA__SASL_PLAIN_PASSWORD = credentials("KAFKA_SASL_PLAIN_PASSWORD")
    CELERY__CREDS = credentials("CELERY_CREDS")
  }

  options {
    timestamps()
    skipDefaultCheckout(true)
    buildDiscarder logRotator(
      artifactDaysToKeepStr: '',
      artifactNumToKeepStr: '',
      daysToKeepStr: '5',
      numToKeepStr: '3'
    )
  }

  parameters {
    text(
      name: 'FILE_ID_LIST',
      defaultValue: '',
      description: 'A list of file ids to re-ingest. Please 1 id per line.'
    )
    string(
      name: 'MAX_BATCH_SIZE',
      defaultValue: '3',
      description: 'How many files to process at once. MUST BE AN INTEGER'
    )
    string(
      name: 'BACKOFF_TIMER',
      defaultValue: '10',
      description: 'How many seconds to wait between 2 consecutive batches. MUST BE AN INTEGER'
    )
  }

  stages {
    stage('Clone repository') {
      steps {
        cleanWs()
        checkout scm
      }
    }

    stage('Script') {
      steps {
        sh '''
          # we need to install the scripts package
          python3.12 -m venv venv
          . venv/bin/activate

          pip install -q -U "pip<24.1"

          # we install now the script requirements
          cd scripts/generic/reprocess_files

          # script expects a CSV file
          echo "$FILE_ID_LIST" | tr ' ' '\n' > input.csv
          pip install -q -r requirements.txt

          python main.py
        '''
      }
    }
  }
  post {
    always {
      archiveArtifacts artifacts: 'scripts/generic/reprocess_files/**.csv', allowEmptyArchive: false
    }
  }
}
