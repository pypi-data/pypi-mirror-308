(function(x,n){typeof exports=="object"&&typeof module<"u"?n(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],n):(x=typeof globalThis<"u"?globalThis:x||self,n(x.trame_annotations={},x.Vue))})(this,function(x,n){"use strict";class C{constructor(e,i=0){this.bounds={x:e.x||0,y:e.y||0,width:e.width,height:e.height},this.maxObjects=typeof e.maxObjects=="number"?e.maxObjects:10,this.maxLevels=typeof e.maxLevels=="number"?e.maxLevels:4,this.level=i,this.objects=[],this.nodes=[]}getIndex(e){return e.qtIndex(this.bounds)}split(){const e=this.level+1,i=this.bounds.width/2,t=this.bounds.height/2,s=this.bounds.x,u=this.bounds.y,h=[{x:s+i,y:u},{x:s,y:u},{x:s,y:u+t},{x:s+i,y:u+t}];for(let r=0;r<4;r++)this.nodes[r]=new C({x:h[r].x,y:h[r].y,width:i,height:t,maxObjects:this.maxObjects,maxLevels:this.maxLevels},e)}insert(e){if(this.nodes.length){const i=this.getIndex(e);for(let t=0;t<i.length;t++)this.nodes[i[t]].insert(e);return}if(this.objects.push(e),this.objects.length>this.maxObjects&&this.level<this.maxLevels){this.nodes.length||this.split();for(let i=0;i<this.objects.length;i++){const t=this.getIndex(this.objects[i]);for(let s=0;s<t.length;s++)this.nodes[t[s]].insert(this.objects[i])}this.objects=[]}}retrieve(e){const i=this.getIndex(e);let t=this.objects;if(this.nodes.length)for(let s=0;s<i.length;s++)t=t.concat(this.nodes[i[s]].retrieve(e));return this.level===0?Array.from(new Set(t)):t}remove(e,i=!1){const t=this.objects.indexOf(e);t>-1&&this.objects.splice(t,1);for(let s=0;s<this.nodes.length;s++)this.nodes[s].remove(e);return this.level===0&&!i&&this.join(),t!==-1}update(e,i=!1){this.remove(e,i),this.insert(e)}join(){let e=Array.from(this.objects);for(let t=0;t<this.nodes.length;t++){const s=this.nodes[t].join();e=e.concat(s)}const i=Array.from(new Set(e));if(i.length<=this.maxObjects){this.objects=i;for(let t=0;t<this.nodes.length;t++)this.nodes[t].objects=[];this.nodes=[]}return e}clear(){this.objects=[];for(let e=0;e<this.nodes.length;e++)this.nodes.length&&this.nodes[e].clear();this.nodes=[]}}class L{constructor(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this.data=e.data}qtIndex(e){const i=[],t=e.x+e.width/2,s=e.y+e.height/2,u=this.y<s,h=this.x<t,r=this.x+this.width>t,m=this.y+this.height>s;return u&&r&&i.push(0),h&&u&&i.push(1),h&&m&&i.push(2),r&&m&&i.push(3),i}}function k(a){return n.getCurrentScope()?(n.onScopeDispose(a),!0):!1}function B(){const a=n.ref(1);if(window){let e=function(){a.value=window.devicePixelRatio,i(),t=window.matchMedia(`(resolution: ${a.value}dppx)`),t.addEventListener("change",e,{once:!0})},i=function(){t==null||t.removeEventListener("change",e)},t;e(),k(i)}return{pixelRatio:a}}function F(a){const e=n.ref(0);let i=null,t;const s=()=>{i&&(i.disconnect(),i=null),t=void 0},u=()=>{i=new ResizeObserver(h=>{for(const r of h)e.value=r.contentRect.width})};return n.watchEffect(()=>{t&&(!a.value||a.value!==t)&&s(),a.value&&(i||u(),t=a.value,i==null||i.observe(t),e.value=t.clientWidth)}),k(s),{width:e}}const G={style:{position:"relative"}},A=["src"],J=.9,K=2,T=16,Q={ImageDetection:n.defineComponent({__name:"ImageDetection",props:{identifier:{},src:{},annotations:{},categories:{},selected:{type:Boolean},containerSelector:{},lineWidth:{},lineOpacity:{}},emits:["hover"],setup(a,{emit:e}){const i=[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[255,0,255],[0,255,255]],t=[8,8];let s;function u(o,l){return l.x>=o.x+o.width||o.x>=l.x+l.width?!1:!(l.y>=o.y+o.height||o.y>=l.y+l.height)}const h=a,r=n.ref(),m=n.computed(()=>{var o;return(o=r.value)==null?void 0:o.getContext("2d",{alpha:!0})}),p=n.ref(),I=n.computed(()=>{var o;return(o=p.value)==null?void 0:o.getContext("2d",{willReadFrequently:!0})}),f=n.ref(),v=n.ref({width:0,height:0}),R=n.ref(),Z=()=>{var o,l;v.value={width:((o=R.value)==null?void 0:o.naturalWidth)??0,height:((l=R.value)==null?void 0:l.naturalHeight)??0}},W=n.computed(()=>n.unref(h.annotations)??[]),D=n.computed(()=>W.value.map(o=>{const l=o.category_id??0,c=i[l%i.length];return{...o,color:c}})),ee=B(),{width:te}=F(r),ie=n.computed(()=>r.value?v.value.width/te.value:1),ne=n.computed(()=>h.lineWidth??K),oe=n.computed(()=>ne.value*ee.pixelRatio.value*ie.value),se=n.computed(()=>h.lineOpacity??J);n.watchEffect(()=>{if(!r.value||!m.value)return;const o=r.value,l=m.value;o.width=v.value.width,o.height=v.value.height,l.clearRect(0,0,o.width,o.height),l.globalCompositeOperation="lighter",l.lineWidth=oe.value;const c=se.value;D.value.forEach(({color:d,bbox:g})=>{l.strokeStyle=`rgba(${[...d,c].join(",")})`,l.strokeRect(g[0],g[1],g[2],g[3])})}),n.watchEffect(()=>{if(!I.value||!p.value)return;const o=p.value,l=I.value;o.width=v.value.width,o.height=v.value.height,l.clearRect(0,0,o.width,o.height),s=new C({width:o.width,height:o.height,maxLevels:8,maxObjects:10}),W.value.forEach((c,d)=>{const g=new L({x:c.bbox[0],y:c.bbox[1],width:c.bbox[2],height:c.bbox[3],data:d});s==null||s.insert(g),l.fillStyle="rgb(255, 0, 0)",l.fillRect(c.bbox[0],c.bbox[1],c.bbox[2],c.bbox[3])})});const N=e;function V(){f.value&&(f.value.style.visibility="hidden")}n.onMounted(V);function le(){N("hover",{id:h.identifier})}function ce(){N("hover",{id:""}),V()}function he(o,l,c){const d=c.getBoundingClientRect(),g=c.width*(o-d.left)/d.width,P=c.height*(l-d.top)/d.height;return[g,P]}const M=n.ref(!1);n.onMounted(()=>{M.value=!0});const re=n.computed(()=>!M.value||!h.containerSelector?null:document.querySelector(h.containerSelector));function ae(o){var X;if(!p.value||p.value.width===0||!f.value||!s||!h.categories||!h.annotations)return;const l=I.value;if(!l)return;const[c,d]=he(o.clientX,o.clientY,p.value);if(!(l.getImageData(c,d,1,1).data[0]>0)){f.value.style.visibility="hidden";return}f.value.style.visibility="visible";const Y=new L({x:c,y:d,width:2,height:2}),fe=s.retrieve(Y).filter(b=>u(b,Y)).filter(b=>b.data!=null).map(b=>{var H;const y=D.value[b.data],ge=((H=h.categories[y.category_id])==null?void 0:H.name)??y.label,pe=y.color,E=document.createElement("li");E.style.textShadow=`rgba(${pe.join(",")},0.6) 1px 1px 3px`;const xe=y.id?` : ${y.id}`:"";return E.textContent=`${ge}${xe}`,E});f.value.replaceChildren(...fe);const[$,z]=[o.offsetX,o.offsetY];let S=$+t[0],_=z+t[1];const w=f.value.getBoundingClientRect(),q=p.value.getBoundingClientRect(),O=((X=re.value)==null?void 0:X.getBoundingClientRect())??{left:0,top:0,width:window.innerWidth,height:window.innerHeight},j={left:q.left+S-O.left,top:q.top+_-O.top,width:w.width+T,height:w.height+T};j.left+j.width>O.width&&(S=$-w.width-t[0]),j.top+j.height>O.height&&(_=z-w.height-t[1]),f.value.style.left=`${S}px`,f.value.style.top=`${_}px`}const de=n.computed(()=>h.selected?"4":"0"),ue=n.computed(()=>n.unref(h.src));return(o,l)=>(n.openBlock(),n.createElementBlock("div",G,[n.createElementVNode("img",{ref_key:"img",ref:R,src:ue.value,style:n.normalizeStyle([{outlineWidth:de.value+"px"},{width:"100%","outline-style":"dotted","outline-color":"red"}]),onLoad:Z},null,44,A),n.createElementVNode("canvas",{ref_key:"visibleCanvas",ref:r,style:{width:"100%",position:"absolute",left:"0",top:"0"}},null,512),n.createElementVNode("canvas",{ref_key:"pickingCanvas",ref:p,style:{opacity:"0",width:"100%",position:"absolute",left:"0",top:"0"},onMouseenter:le,onMousemove:ae,onMouseleave:ce},null,544),n.createElementVNode("ul",{ref_key:"labelContainer",ref:f,style:{position:"absolute","z-index":"10",padding:"0.4rem","white-space":"pre","font-size":"small","border-radius":"0.2rem","border-color":"rgba(127, 127, 127, 0.75)","border-style":"solid","border-width":"thin","background-color":"#efefef","list-style-type":"none"}},null,512)]))}})};function U(a){Object.entries(Q).forEach(([e,i])=>{a.component(e,i)})}x.install=U,Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=trame_annotations.umd.cjs.map
